<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<canvas id="cv" width=100 height=100></canvas>
<title>jeforth 4.03</title>
<style> body { font-family: 'Courier New', monospace; font-size: 14px;}</style>
<script src="jeforth_403.js"> // jeforth virtual machine KsanaVm // </script>
</head><body><br/><br/>
<textarea id="tib" cols=80 rows=10 size="60" onkeydown="if (13===event.keyCode) fortheval()">
: square dup * ; : quad square square ; : octet quad quad ; 
8 octet . 4 octet . 
</textarea><br/><br/>
<div id="log" style="overflow: auto; height: 300px; width: 600px;" ></div> 
</body>
<script>
    var canvas = document.getElementById("cv"); 
    var context = canvas.getContext("2d");
    var width = canvas.width;
    var height = canvas.height;
    var imagedata = context.createImageData(width, height);
    var pixelindex = 0;
    function createImage() {
      for (var y=0; y<height; y++) {
        for (var x=0; x<width; x++) {
          var red = x>33? 255:0;
          var green = (x>33 && x<66)? 255:0;
          var blue = x<66? 255:0;
          imagedata.data[pixelindex] = red;     // Red
          imagedata.data[pixelindex+1] = green; // Green
          imagedata.data[pixelindex+2] = blue;  // Blue
          imagedata.data[pixelindex+3] = 255;   // Alpha
          pixelindex+=4;
    }}}
    createImage();
    context.putImageData(imagedata, 0, 0);
    var log=document.getElementById("log");
    log.innerHTML="jeforth 2.02<br/>";
    var tib=document.getElementById("tib");
    function ticktype(t){log.innerHTML=log.innerHTML+t;}  //

    var workerCode = jeforth.toString() + '\njeforth();\n';
    var worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type: 'text/javascript'})));
    var audio;
    const sharedArrayBuffer = new SharedArrayBuffer(64 * 1024);
    const sharedArrayInt = new Int32Array(sharedArrayBuffer); 
    const sharedArray = new Float64Array(sharedArrayBuffer); 

    worker.postMessage(sharedArrayBuffer);
    setInterval(function() {
      var op = Atomics.load(sharedArrayInt, 0);
      switch (op) {
        case 1:  // Type
          var len = sharedArray[1];
          var text = '';
          for (var i = 0; i < len; ++i) {
            text += String.fromCharCode(sharedArray[i + 2]);
          }
          ticktype(text);
          Atomics.store(sharedArrayInt, 0, 0);
          Atomics.notify(sharedArrayInt, 0, 1);
          break;
        case 2:  // Readline
          Atomics.store(sharedArrayInt, 0, -1);
          break;
        case 3:  // Beep
          // Stop early on bad input.
          if (!isFinite(sharedArray[2])) {
            Atomics.store(sharedArrayInt, 0, 0);
            Atomics.notify(sharedArrayInt, 0, 1);
            break;
          }
          var osc = audio.createOscillator();
          var amp = audio.createGain();
          osc.connect(amp);
          osc.frequency.value = sharedArray[2];  // freq
          osc.type = "square";
          amp.connect(audio.destination);
          amp.gain.value = sharedArray[1];
          osc.start(audio.currentTime);
          osc.stop(audio.currentTime + sharedArray[3]);
          Atomics.store(sharedArrayInt, 0, -1);
          osc.onended = function() {
            Atomics.store(sharedArrayInt, 0, 0);
            Atomics.notify(sharedArrayInt, 0, 1);
          };
          break;
        case 4:  // Finish
          tib.value="";
          log.scrollTop = log.scrollHeight;
          Atomics.store(sharedArrayInt, 0, 0);
          Atomics.notify(sharedArrayInt, 0, 1);
          break;
      }
    }, 1);

    function fortheval() {
      if (audio === undefined) {
        // Done here to wait for user gesture.
        audio = new AudioContext();
      }
      log.innerHTML+="<font color='blue'>"+tib.value+"  </font>";
      sharedArray[1] = tib.value.length;
      for (var i = 0; i < tib.value.length; ++i) {
        sharedArray[i + 2] = tib.value.charCodeAt(i);
      }
      Atomics.store(sharedArrayInt, 0, 0);
      Atomics.notify(sharedArrayInt, 0, 1);
    }
 
</script>
</html>
